<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel World Multiplayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplex-noise/2.4.0/simplex-noise.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #1a202c;
            color: #e2e8f0;
            font-family: 'Press+Start+2P', cursive;
            margin: 0;
            overflow: hidden;
        }
        canvas {
            background-color: #2d3748;
            border: 2px solid #4a5568;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            image-rendering: pixelated;
        }
        #main-menu-container, #game-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #menu-background-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        .main-menu {
            position: relative;
            z-index: 2;
            background-color: rgba(45, 55, 72, 0.8);
            backdrop-filter: blur(5px);
            padding: 2rem;
            border-radius: 1rem;
            border: 2px solid #4a5568;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            text-align: center;
        }
        .main-menu h1 {
            color: #ffffff;
            text-shadow: 4px 4px 0px #ff63c3, 8px 8px 0px #4c51bf;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        .main-menu p {
            color: #a0aec0;
            margin-bottom: 1.5rem;
            font-size: 0.8rem;
        }
        #player-name-input {
            font-family: 'Press Start 2P', cursive;
            background-color: #1a202c;
            border: 2px solid #4a5568;
            color: white;
            padding: 0.75rem;
            margin-bottom: 1.5rem;
            width: 100%;
            text-align: center;
            border-radius: 0.5rem;
        }
        #player-name-input::placeholder {
            color: #718096;
        }
        .start-button {
            background: linear-gradient(45deg, #4c51bf, #667eea);
            transition: all 0.3s ease;
            font-family: 'Press Start 2P', cursive;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            padding: 1rem 2rem;
        }
        .start-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 15px rgba(0,0,0,0.3);
        }
        
        /* UPDATED: In-game UI layout */
        #game-ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Make UI click-through */
        }
        #players-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(45, 55, 72, 0.7);
            padding: 1rem;
            border-radius: 0.5rem;
            max-width: 300px;
            font-family: 'Inter', sans-serif;
            color: #e2e8f0;
        }
        #resource-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background-color: rgba(0,0,0,0.4);
            padding: 10px;
            border-radius: 0.5rem;
            border: 2px solid #4a5568;
        }
        .resource-slot {
            width: 60px;
            height: 60px;
            background-color: rgba(0,0,0,0.5);
            border: 2px solid #718096;
            border-radius: 0.25rem;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .resource-slot img {
            width: 40px;
            height: 40px;
        }
        .resource-count {
            position: absolute;
            bottom: 2px;
            right: 5px;
            color: white;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem;
            text-shadow: 1px 1px 2px black;
        }

        #chat-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 350px;
            z-index: 10;
            font-family: 'Inter', sans-serif;
            pointer-events: all; /* Allow interaction with chat */
        }
        #chat-messages {
            height: 150px;
            overflow-y: auto;
            background-color: rgba(0,0,0,0.4);
            padding: 10px;
            border-radius: 0.5rem;
            margin-bottom: 5px;
            color: white;
            font-size: 0.9rem;
        }
        #chat-messages p {
            margin-bottom: 5px;
            word-wrap: break-word;
        }
        #chat-input {
            width: 100%;
            background-color: rgba(0,0,0,0.6);
            border: 1px solid #4a5568;
            color: white;
            padding: 10px;
            border-radius: 0.5rem;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body>

    <!-- Main Menu Container -->
    <div id="main-menu-container">
        <canvas id="menu-background-canvas"></canvas>
        <div id="main-menu" class="main-menu">
            <h1>Pixel World</h1>
            <p>Game Multiplayer Open-World</p>
            <input type="text" id="player-name-input" placeholder="Masukkan Nama Anda" maxlength="10">
            <button id="start-game-button" class="start-button text-white font-bold rounded-lg w-full">
                Mulai Main
            </button>
        </div>
    </div>

    <!-- Kontainer Game (Disembunyikan Awalnya) -->
    <div id="game-content" class="hidden flex-col md:flex-row gap-8">
        <div id="game-container" class="relative">
            <canvas id="gameCanvas"></canvas>
            <div id="loading-overlay" class="absolute inset-0 bg-gray-800 bg-opacity-75 flex flex-col items-center justify-center rounded-lg text-center p-4">
                <p id="loading-text" class="text-white text-2xl mb-4">Menghubungkan ke Server...</p>
                <div id="spinner" class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
            </div>
            
            <!-- UPDATED: Game UI Overlay -->
            <div id="game-ui-overlay">
                <div id="players-panel">
                    <h2 class="text-lg font-bold mb-2 text-white" style="font-family: 'Press Start 2P', cursive;">Pemain Lain:</h2>
                    <ul id="other-players-list" class="list-disc list-inside text-sm">
                        <!-- Daftar pemain lain akan muncul di sini -->
                    </ul>
                </div>

                <div id="resource-bar">
                    <div class="resource-slot">
                        <img id="wood-icon" src="">
                        <span id="wood-count" class="resource-count">0</span>
                    </div>
                    <div class="resource-slot">
                        <img id="stone-icon" src="">
                        <span id="stone-count" class="resource-count">0</span>
                    </div>
                </div>

                <div id="chat-container">
                    <div id="chat-messages"></div>
                    <input type="text" id="chat-input" placeholder="Tekan Enter untuk chat...">
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, onDisconnect, remove, push, serverTimestamp, query, limitToLast } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCkMCqxG2omP3Hzt55ceIyp5IEX5ZP_xTo",
          authDomain: "tree-48b1b.firebaseapp.com",
          projectId: "tree-48b1b",
          storageBucket: "tree-48b1b.appspot.com",
          messagingSenderId: "778582971003",
          appId: "1:778582971003:web:7e7343cacb2ab3c80148de",
          databaseURL: "https://tree-48b1b-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        // --- DEKLARASI VARIABEL GLOBAL ---
        let app, database, auth;
        const appId = 'pixel-world-multiplayer';
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        
        const TILE_SIZE = 32;
        const WORLD_SIZE = 50;
        const RENDER_DISTANCE = 15;

        let playerId, playerName;
        let playerRef;
        let players = {};
        let worldData = {};
        let inventory = { wood: 0, stone: 0 };
        let worldSeed = '';
        const worldObjects = {};
        const keys = { w: false, a: false, s: false, d: false };
        let isGameRunning = false;
        let menuAnimationId;
        let isChatting = false;

        // --- PENGATURAN AWAL CANVAS ---
        ctx.imageSmoothingEnabled = false;
        canvas.width = RENDER_DISTANCE * 2 * TILE_SIZE;
        canvas.height = RENDER_DISTANCE * 2 * TILE_SIZE;

       // --- ASET GAME ---
        const assets = {
            player: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAHBJREFUOE9jZKAQMJKggb8x/B+G/wT/Bf4P/B8Z/pPhP9M/s39n+M/w/+k/2H8y/Wf7z/Sf7T84/DP9p/tP9h8M/wH+M/xn+s/0Hww/mP4z/Of6T/YfDD8Y/vP8Z/rP9B8M/wHqAwBfVpZl3aY8AAAAAElFTSuQmCC',
            tree: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABQCAYAAACpv3NFAAAAAXNSR0IArs4c6QAABZFJREFUeJztW09PG0cU/zk1ogZFvbBFCjgXDgYipAYJRzKHXCLlGkeIT9EvkAMnH/oJ+iUsFM6VcokESBipiYRi44MPjUGVte6BVmDRWNCDmeXteHa9M/Nm6WF/Esrszuzse7/3Z97MOkCGDBkyZMiQIUOGdFFY8G4LC97tQ8uRczEpVWxw7ufE9eDcz4n+1Z0yAKBZa4COdSFPHPKckwlFhXIA0Kw1qLJj/fS6WWvcqghzCbYXCKs2aw1U6xUAQPtkCGBkZVnp0lo+NKa0lkf7ZBga26w1nJPwiGMS6vKrO2XsbR8CuFeyWq8EbXpfvlYR5TpXWLNbWPBuq/VKyHqyggLtk2Fkn2rM3vZh4E1724dOvIGNANcQXgXw5garEEh7GVvdKWN1p8z6XmMCRNITMd8+GQYJzQXk0OLKDSxJUE5y3FDlDi5vsCJAFDF0KXMBOq9YZrneZUQAdX9ayQFwGgrtkyG4E65RNqWlrAouw4GCY2UwXk4oCbSqS0t5OexM6wSrEKACuFwBVOB6rzYBctaVY56biLj5qPVNoeUy8jaWrs3U/blCIek8dNOlGwbGyyBdimRBOfNAlAdweZp20lDFPxcEkSrl6LtU/aZbZy0PUMV/EiQdR5WXyRW5hs5Ft9Gmy6B2CFTrlaD40fGApAVSaS0fzKs6N4g6SzAtibUJ2K/nxg4t4hQzLZPjCJPnqtYrqNYrRiRoETA493P+7kHonhBSJaysvA4JqqQqv4MjERolQWD8YDPuFCiuPykm1QOmlaCWVIUF79bb2oS38m3i2ElhoZs/gGhPsDkuM6oD/NZUaBeoUiaqLogKlUkx76rkNsoB/u4BvK1N5ZgkCVFuJ80RUeu/DbQ9QLiaKgxoQpSVpW48yZqTiBJo1hrwtjbhbW0aL4MspZxOoSOPj2tP2ltEeaEOjFYBkQj91tRIkJik6LemEiXNpJDn81tT8HcPjJOgsQeolJfvcSlP5xHEeyvfgvi3+U5glAPkYkgIKQRU3ZfbUfBbU8pn5Gc5lAcszgRFW45Dan0ZsrdEeYrKk1S47Axx9enIigSjEBCfsGeevwgJM7uUT2xlCurWceMuO/zHbtYfRi47Q/i7B5hdyo/dlxHl3lH9l53h2DxXn46Cf22tD1h+HBWhMPP8RUCAcEv5nkxQFOSxKiI5FBew8gAqhLBWnPJUmaj27FI+0uouwMIiTYoiLyQlQu6nJFJQEjg/j7P/4ICGhUCUQnFjhMKUUBc/kGD5OkwhCxmlfPlxMZTQ6DWdiyvZRcHZD5CiwgIAyo+LAIDGP93QNb2X1k/mnH3IIwosA0ct4F7Rjfnpu65i6JnR/SI+nv6+MnoOAHDqSkbAQQjcYZn8YXDurwzO/RUAePusEBq4MT8dEFKcU4oTmosb3ARMFLS06AWKbsxPRyltPL8uOEMgsWClRQ+Aj27/JmgD0+j2b3TexRIaXB6gZZX2ma9U1sAbrMFBgJYgHz73gvarn+ZTfbcKrpJgLIT122d+6PohYEuAtgWEmx/3rgHce4Sm+1vJQJGaB7xcXm+9e/0UwL2ywvLHveug/e71U7xcXm+lJZcNAUbMj7L+CMW5R4EnHPeuQ31pyAIA35k+CGAu6UBh/faZj7/+vsL7LwNszE/jh5kc3qw/wX7nAgCw37nAj9//izfrT9C9mPn5j/6fv2rI09dVAEg5CXb7N3j/ZRBcU4vflb/o9m/QPvNTCwWbQugUCVxPWP/D5x6Oe9eBosB6q3jmj5Hw0ay8MS6KbHdcxrEnrPv2WQGlRQ+//PaVkKONByMAcLRJ0YBVSfwghdD/CVyHDg/lBdYbIs5Tl7RJYNkNch87pUUC2ymRq3M3V0SwH4+lcfBoS4bTM8HU/7MyJhPiVOEMGTJkyJAhQwaB/wCcF1ybPAOXlAAAAABJRU5ErkJggg==',
            grass: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAB1JREFUOI1jtOv0+M9AAWCiRPOoAaMGjBowmAwAAJhEAi4/QQzBAAAAAElFTkSuQmCC',
            dirt: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAB1JREFUOI1jfLKs6D8DBYCJEs2jBowaMGrAYDIAAFnyAxuTOlahAAAAAElFTkSuQmCC',
            rock: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAD1JREFUOE9jZKAQMFKon2HsgLpB9A+IfgDxG5B8AUQ/gPgNSD4B4j8g+QSI/wDxG5B8A8Q/gPgNSD4A8gsAALb3oXgAR2EAAAAASUVORK5CYII=',
            wood_icon: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAFBJREFUWEft0rENwCAQBEG+y/TfKQiBhhBE/s0I4fC872t2dnb2/N4AQQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECLwXwL2vN2PH2wQIECBAgAABAW4B7koJCVVpQjEAAAAASUVORK5CYII=',
            stone_icon: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAD1JREFUWEft0sEJACAMA0D+/2d7YyAYQaggA/dJ4uC872t2dnb2/N4AQQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECLwXwL2vN2PH2wQIECBAgAABAW4B7koJCVVpQjEAAAAASUVORK5CYII='};
        const images = {};

        function loadAssets() {
            let assetsLoaded = 0;
            const assetKeys = Object.keys(assets);
            return new Promise(resolve => {
                assetKeys.forEach(key => {
                    images[key] = new Image();
                    images[key].src = assets[key];
                    images[key].onload = () => {
                        assetsLoaded++;
                        if (assetsLoaded === assetKeys.length) resolve();
                    };
                });
            });
        }
        
        const menuCanvas = document.getElementById('menu-background-canvas');
        const menuCtx = menuCanvas.getContext('2d');
        let clouds = [];

        function setupMenu() {
            menuCanvas.width = window.innerWidth;
            menuCanvas.height = window.innerHeight;
            
            for(let i = 0; i < 10; i++) {
                clouds.push({
                    x: Math.random() * menuCanvas.width,
                    y: Math.random() * menuCanvas.height * 0.5,
                    size: Math.random() * 50 + 20,
                    speed: Math.random() * 0.5 + 0.1
                });
            }
            animateMenu();
        }

        function animateMenu() {
            menuCtx.clearRect(0, 0, menuCanvas.width, menuCanvas.height);
            
            const sky = menuCtx.createLinearGradient(0, 0, 0, menuCanvas.height);
            sky.addColorStop(0, '#3a7bd5');
            sky.addColorStop(1, '#3a6073');
            menuCtx.fillStyle = sky;
            menuCtx.fillRect(0, 0, menuCanvas.width, menuCanvas.height);

            menuCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            clouds.forEach(cloud => {
                menuCtx.beginPath();
                menuCtx.arc(cloud.x, cloud.y, cloud.size, 0, Math.PI * 2);
                menuCtx.fill();
                
                cloud.x += cloud.speed;
                if(cloud.x > menuCanvas.width + cloud.size) {
                    cloud.x = -cloud.size;
                }
            });

            menuAnimationId = requestAnimationFrame(animateMenu);
        }

        function generateWorld(seed) {
            const noise = new SimplexNoise(seed);
            for (let y = 0; y < WORLD_SIZE; y++) {
                for (let x = 0; x < WORLD_SIZE; x++) {
                    const key = `${x},${y}`;
                    const noiseValue = noise.noise2D(x / 10, y / 10);
                    worldData[key] = noiseValue > 0.2 ? 'grass' : 'dirt';
                    const objectNoise = noise.noise2D(x / 5, y / 5);
                    if (objectNoise > 0.65 && worldData[key] === 'grass') {
                         worldObjects[key] = { type: 'tree', x, y };
                    } else if (objectNoise < -0.65 && worldData[key] === 'dirt') {
                         worldObjects[key] = { type: 'rock', x, y };
                    }
                }
            }
            console.log("Dunia berhasil digenerate dengan seed:", seed);
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function update() {
            if (!playerId || !players[playerId] || isChatting) return;
            const player = players[playerId];
            const speed = 0.1;
            let newX = player.x;
            let newY = player.y;
            if (keys.w) newY -= speed;
            if (keys.s) newY += speed;
            if (keys.a) newX -= speed;
            if (keys.d) newX += speed;
            newX = Math.max(0, Math.min(WORLD_SIZE - 1, newX));
            newY = Math.max(0, Math.min(WORLD_SIZE - 1, newY));
            if (player.x !== newX || player.y !== newY) {
                player.x = newX;
                player.y = newY;
                set(playerRef, player);
                checkInteractions(player);
            }
        }
        
        function checkInteractions(player) {
            const playerTileX = Math.round(player.x);
            const playerTileY = Math.round(player.y);
            for (let yOffset = -1; yOffset <= 1; yOffset++) {
                for (let xOffset = -1; xOffset <= 1; xOffset++) {
                    const objectKey = `${playerTileX + xOffset},${playerTileY + yOffset}`;
                    const object = worldObjects[objectKey];
                    if (object) {
                        if (object.type === 'tree') {
                            inventory.wood++;
                            document.getElementById('wood-count').innerText = inventory.wood;
                        } else if (object.type === 'rock') {
                            inventory.stone++;
                            document.getElementById('stone-count').innerText = inventory.stone;
                        }
                        
                        delete worldObjects[objectKey];
                        const objectRef = ref(database, `apps/${appId}/world/objects/${objectKey}`);
                        remove(objectRef);
                        return;
                    }
                }
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!playerId || !players[playerId]) return;
            const player = players[playerId];
            const cameraX = player.x * TILE_SIZE - canvas.width / 2;
            const cameraY = player.y * TILE_SIZE - canvas.height / 2;
            const startCol = Math.floor(cameraX / TILE_SIZE);
            const endCol = startCol + (canvas.width / TILE_SIZE) + 1;
            const startRow = Math.floor(cameraY / TILE_SIZE);
            const endRow = startRow + (canvas.height / TILE_SIZE) + 1;

            for (let y = startRow; y < endRow; y++) {
                for (let x = startCol; x < endCol; x++) {
                    const tileKey = `${x},${y}`;
                    const tileType = worldData[tileKey] || 'dirt';
                    if (images[tileType]) {
                        ctx.drawImage(images[tileType], (x * TILE_SIZE) - cameraX, (y * TILE_SIZE) - cameraY, TILE_SIZE, TILE_SIZE);
                    }
                }
            }
            
            for (const key in worldObjects) {
                const obj = worldObjects[key];
                const imageToDraw = images[obj.type];
                if (obj.x >= startCol && obj.x <= endCol && obj.y >= startRow && obj.y <= endRow && imageToDraw) {
                    const drawSize = obj.type === 'tree' ? TILE_SIZE : TILE_SIZE / 2;
                    const drawX = (obj.x * TILE_SIZE) - cameraX + (TILE_SIZE - drawSize) / 2;
                    const drawY = (obj.y * TILE_SIZE) - cameraY + (TILE_SIZE - drawSize) / 2;
                    ctx.drawImage(imageToDraw, drawX, drawY, drawSize, drawSize);
                }
            }

            for (const id in players) {
                const p = players[id];
                 if (p.x >= startCol && p.x <= endCol && p.y >= startRow && p.y <= endRow) {
                    ctx.drawImage(images.player, (p.x * TILE_SIZE) - cameraX, (p.y * TILE_SIZE) - cameraY, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = 'white';
                    ctx.font = '12px "Press Start 2P"';
                    ctx.textAlign = 'center';
                    ctx.fillText(p.name || `Pemain`, (p.x * TILE_SIZE) - cameraX + TILE_SIZE / 2, (p.y * TILE_SIZE) - cameraY - 5);
                 }
            }
        }

        // --- KONEKSI FIREBASE ---
        async function setupServerListeners(initialPlayerData) {
            const worldObjectsRef = ref(database, `apps/${appId}/world/objects`);
            onValue(worldObjectsRef, (snapshot) => {
                const serverObjects = snapshot.val() || {};
                for (const key in worldObjects) {
                    if (serverObjects[key] === null) {
                        delete worldObjects[key];
                    }
                }
                Object.assign(worldObjects, serverObjects);
            });

            playerRef = ref(database, `apps/${appId}/players/${playerId}`);
            await set(playerRef, initialPlayerData);
            onDisconnect(playerRef).remove();

            const allPlayersRef = ref(database, `apps/${appId}/players`);
            onValue(allPlayersRef, (snapshot) => {
                const serverPlayers = snapshot.val() || {};
                players = serverPlayers;
                if (!players[playerId]) {
                    players[playerId] = initialPlayerData;
                }
                updateOtherPlayersList();
            });

            const chatRef = ref(database, `apps/${appId}/chat`);
            const chatQuery = query(chatRef, limitToLast(15));
            onValue(chatQuery, (snapshot) => {
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = '';
                snapshot.forEach(childSnapshot => {
                    const message = childSnapshot.val();
                    const messageEl = document.createElement('p');
                    
                    // FIXED: Securely create chat message elements to prevent XSS
                    const nameEl = document.createElement('strong');
                    nameEl.textContent = message.name + ': '; // Safely set the name
                    
                    const textNode = document.createTextNode(message.text); // Safely set the message text

                    messageEl.appendChild(nameEl);
                    messageEl.appendChild(textNode);
                    chatMessages.appendChild(messageEl);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        async function initGame() {
            if (!database) return;
            
            loadingText.textContent = "Memuat Aset...";
            await loadAssets();
            // Set icons for resource bar
            document.getElementById('wood-icon').src = images.wood_icon.src;
            document.getElementById('stone-icon').src = images.stone_icon.src;
            console.log("Aset berhasil dimuat.");
            
            loadingText.textContent = "Login...";
            try {
                await signInAnonymously(auth);
                playerId = auth.currentUser.uid;
                console.log("Berhasil login sebagai:", playerId);
                
                loadingText.textContent = "Mencari Dunia...";
                const worldSeedRef = ref(database, `apps/${appId}/world/seed`);

                onValue(worldSeedRef, (snapshot) => {
                    const seed = snapshot.val();
                    if (seed) {
                        worldSeed = seed;
                        console.log("Bergabung ke dunia yang ada dengan seed:", worldSeed);
                    } else {
                        console.log("Dunia tidak ditemukan, membuat yang baru...");
                        worldSeed = Date.now().toString();
                        set(worldSeedRef, worldSeed);
                    }
                    
                    if (!isGameRunning) {
                        isGameRunning = true;
                        generateWorld(worldSeed);
                        
                        const startX = Math.floor(Math.random() * WORLD_SIZE);
                        const startY = Math.floor(Math.random() * WORLD_SIZE);
                        const initialPlayerData = { id: playerId, x: startX, y: startY, name: playerName };
                        players[playerId] = initialPlayerData;
                        
                        loadingOverlay.style.display = 'none';
                        gameLoop();
                        setupServerListeners(initialPlayerData);
                    }

                }, (error) => {
                     console.error("Gagal membaca seed dunia:", error);
                     loadingOverlay.innerHTML = `<p class="text-red-500">Error: Gagal membaca data dunia. Pastikan aturan Realtime Database Anda sudah benar.</p>`;
                }, { onlyOnce: true });

            } catch (error) {
                console.error("Firebase Auth/Login Error:", error);
                loadingText.textContent = `Error: ${error.message}`;
            }
        }
        
        function updateOtherPlayersList() {
            const listElement = document.getElementById('other-players-list');
            listElement.innerHTML = '';
            let count = 0;
            for (const id in players) {
                if (id !== playerId) {
                    const li = document.createElement('li');
                    li.textContent = players[id].name || `Pemain ${id.substring(0, 6)}`;
                    listElement.appendChild(li);
                    count++;
                }
            }
            if (count === 0) {
                 const li = document.createElement('li');
                 li.textContent = 'Anda sendirian.';
                 listElement.appendChild(li);
            }
        }

        // --- EVENT LISTENERS ---
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const chatInput = document.getElementById('chat-input');
                if (isChatting) {
                    const messageText = chatInput.value.trim();
                    if (messageText) {
                        const chatRef = ref(database, `apps/${appId}/chat`);
                        push(chatRef, {
                            name: playerName,
                            text: messageText,
                            timestamp: serverTimestamp()
                        });
                    }
                    chatInput.value = '';
                    chatInput.style.display = 'none';
                    isChatting = false;
                } else {
                    chatInput.style.display = 'block';
                    chatInput.focus();
                    isChatting = true;
                }
            }
            if (!isChatting && keys[e.key.toLowerCase()] !== undefined) {
                keys[e.key.toLowerCase()] = true;
            }
        });
        window.addEventListener('keyup', (e) => {
            if (!isChatting && keys[e.key.toLowerCase()] !== undefined) {
                keys[e.key.toLowerCase()] = false;
            }
        });

        document.getElementById('start-game-button').addEventListener('click', () => {
            const nameInput = document.getElementById('player-name-input');
            playerName = nameInput.value.trim();
            if (!playerName) {
                playerName = `Pemain${Math.floor(Math.random() * 1000)}`;
            }

            const mainMenuContainer = document.getElementById('main-menu-container');
            if (mainMenuContainer) {
                mainMenuContainer.remove();
            }
            cancelAnimationFrame(menuAnimationId);
            document.getElementById('game-content').classList.remove('hidden');
            
            try {
                app = initializeApp(firebaseConfig);
                database = getDatabase(app);
                auth = getAuth(app);
                initGame(); 
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingOverlay.innerHTML = `<p class="text-red-500">Error Inisialisasi Firebase. Periksa konfigurasi Anda.</p>`;
            }
        });

        // --- INITIALIZE MENU ---
        window.onload = setupMenu;
    </script>
</body>
</html>

